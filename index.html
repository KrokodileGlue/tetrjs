<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>tetr.js</title>
		<style>
		* { padding: 0; margin: 0; }
		canvas { background: #eee; display: block; margin: 0 auto; }
		</style>
	</head>
	<body>
		<canvas id="canvas" width="960" height="640"></canvas>

		<script>
		var canvas = document.getElementById("canvas");
		var ctx = canvas.getContext("2d");

		document.addEventListener("keydown", keyDownHandler, false);
		/* document.addEventListener("keyup", keyUpHandler, false); */

		var rightPressed = false;
		var leftPressed = false;
		var upPressed = false;
		var downPressed = false;
		var spacePressed = false;

		function keyDownHandler(e) {
			if (e.keyCode == 39) {
				rightPressed = true;
			} else if (e.keyCode == 37) {
				leftPressed = true;
			} else if (e.keyCode == 38) {
				upPressed = true;
			} else if (e.keyCode == 40) {
				downPressed = true;
			} else if (e.keyCode == 32) {
				spacePressed = true;
			}
		}

		var field = new Array();

		var shapes = [
			[0, 0, -1, 0, 1, 0, 0, 1], // T piece
			[0, 0, 0, -1, 0, 1, 1, 1], // L piece
			[0, 0, 1, 0, 0, 1, 1, 1], // O piece
			[0, 0, 0, -1, 0, 1, -1, 1], // J piece
			[0, 0, 0, -1, 0, 1, 0, 2], // I piece
			[0, 0, 1, 0, 0, 1, -1, 1], // S piece
			[0, 0, -1, 0, 0, 1, 1, 1], // Z piece
		];

		var cols = [
			"#0095DD",
			"#1df99a",
			"#ffe502",
			"#ff011b",
			"#97ff30",
			"#a500ff",
			"#ff006e",
		]

		function Piece (type) {
			this.b = shapes[type];
			this.col = cols[type];
			this.x = 4;
			this.y = 1;
			this.type = type;
			this.rotateRight = function () {
				if (this.type == 2) return;
				for (var i = 0; i < 4; i++) {
					var temp = this.b[i * 2 + 1];
					this.b[i * 2 + 1] = this.b[i * 2];
					this.b[i * 2] = -temp;
				}
			}
			this.rotateLeft = function () {
				if (this.type == 2) return;
				for (var i = 0; i < 4; i++) {
					var temp = this.b[i * 2 + 1];
					this.b[i * 2 + 1] = -this.b[i * 2];
					this.b[i * 2] = temp;
				}
			}
			this.draw = function () {
				ctx.beginPath();
				ctx.fillStyle = this.col;
				for (var i = 0; i < 4; i++) {
					ctx.rect((this.x + this.b[i * 2] + 19) * pieceSize,
						(this.y + this.b[i * 2 + 1] + 6) * pieceSize,
						pieceSize,
						pieceSize);
				}
				ctx.fill();
				//ctx.stroke();
				ctx.closePath();
			}
			this.colliding = function () {
				for (var i = 0; i < 4; i++) {
					var x = p.x + p.b[i * 2];
					var y = p.y + p.b[i * 2 + 1];
					if (field[y][x] != null) return true;
				}
				return false;
			}
		}

		var pieceSize = 20;
		var t = 0;
		var p;
		var gameOver = false;

		for (var y = -5; y < 20; y++) {
			field[y] = new Array();
			field[y][-1] = '#afafaf';
			field[y][10] = '#afafaf';
		}

		field[20] = new Array();

		for (var i = 0; i < 10; i++) {
			field[20][i] = '#afafaf';
		}

		function collision() {
			/* Put the piece into the field. */
			for (var i = 0; i < 4; i++) {
				var x = p.x + p.b[i * 2];
				var y = p.y + p.b[i * 2 + 1];
				field[y][x] = p.col;
			}

			/* Check for full lines. */
			for (var y = 19; y >= 0; y--) {
				var full = true;
				for (var x = 0; x < 10; x++) {
					if (field[y][x] == null) {
						full = false;
						break;
					}
				}
				if (!full) continue;
				for (var Y = y; Y > 0; Y--) {
					field[Y] = field[Y - 1];
				}
				y++;
			}
		}

		function render() {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			p.draw();

			for (var i = 0; i < 20; i++) {
				for (var j = 0; j < 10; j++) {
					if (field[i][j] == null) continue;
					ctx.beginPath();
					ctx.fillStyle = field[i][j];
					ctx.rect((19 + j) * pieceSize,
						(i + 6) * pieceSize,
						pieceSize,
						pieceSize);
					ctx.fill();
					ctx.closePath();
				}
			}

			ctx.beginPath();
			ctx.rect(19 * pieceSize,
				6 * pieceSize,
				10 * pieceSize,
				20 * pieceSize);
			ctx.stroke();
			ctx.closePath();
		}

		function draw() {
			if (t == 0) p = new Piece(Math.floor(Math.random() * 7));
			if (gameOver) return;

			/* Check for overflow. */
			for (var i = 0; i < 4; i++) {
				if (p.y + p.b[i * 2 + 1] < 0) {
					debugger;
					gameOver = true;
					return;
				}
			}

			t++;
			if (t % 25 == 0) p.y++;

			/* Check for collisions with the field. */
			for (var i = 0; i < 4; i++) {
				var x = p.x + p.b[i * 2];
				var y = p.y + p.b[i * 2 + 1];

				if (field[y][x] != null) {
					p.y--;
					collision();
					t = 0;
					render();
					return;
				}
			}

			if (spacePressed) {
				while (!p.colliding()) p.y++;
				spacePressed = false;
				p.y--;
				collision();
				render();
				t = 0;
				return;
			}

			if (leftPressed) p.x--;
			if (p.colliding()) p.x++;
			if (rightPressed) p.x++;
			if (p.colliding()) p.x--;

			if (upPressed) p.rotateRight();
			if (p.colliding()) {
				p.rotateRight();
				p.rotateRight();
				p.rotateRight();
			}

			if (downPressed) p.rotateLeft();
			if (p.colliding()) {
				p.rotateRight();
				p.rotateRight();
				p.rotateRight();
			}

			leftPressed = rightPressed = upPressed
			= downPressed = spacePressed = false;

			render();
		}

		setInterval(draw, 10);
		</script>
	</body>
</html>
